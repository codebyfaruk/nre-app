<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Returns - Electronics Shop</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../css/custom.css">
</head>
<body class="bg-gray-100">
    <!-- Sidebar (same structure) -->
    <div id="sidebar" class="fixed left-0 top-0 h-full w-64 bg-gray-900 text-white z-50 transform -translate-x-full lg:translate-x-0 transition-transform duration-300">
        <div class="p-6 border-b border-gray-800">
            <h1 class="text-2xl font-bold flex items-center">
                <i class="fas fa-store mr-3"></i>
                Electronics Shop
            </h1>
        </div>

        <nav class="p-4 space-y-2">
            <a href="../dashboard.html" class="flex items-center px-4 py-3 hover:bg-gray-800 rounded-lg">
                <i class="fas fa-home w-6"></i><span>Dashboard</span>
            </a>
            <a href="pos.html" class="flex items-center px-4 py-3 hover:bg-gray-800 rounded-lg">
                <i class="fas fa-cash-register w-6"></i><span>POS</span>
            </a>
            <a href="sales.html" class="flex items-center px-4 py-3 hover:bg-gray-800 rounded-lg">
                <i class="fas fa-receipt w-6"></i><span>Sales</span>
            </a>
            <a href="returns.html" class="flex items-center px-4 py-3 bg-blue-600 rounded-lg">
                <i class="fas fa-undo w-6"></i><span>Returns</span>
            </a>
            <a href="#" onclick="logout()" class="flex items-center px-4 py-3 hover:bg-red-600 rounded-lg mt-4">
                <i class="fas fa-sign-out-alt w-6"></i><span>Logout</span>
            </a>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="lg:ml-64">
        <div class="bg-white shadow-md px-6 py-4">
            <button onclick="toggleSidebar()" class="lg:hidden text-gray-600">
                <i class="fas fa-bars text-2xl"></i>
            </button>
            <h2 class="text-2xl font-bold text-gray-800">Returns Management</h2>
        </div>

        <div class="p-6">
            <!-- Filter Tabs -->
            <div class="bg-white rounded-lg shadow-md mb-6">
                <div class="flex border-b">
                    <button onclick="filterReturns('all')" class="px-6 py-3 font-semibold border-b-2 border-blue-600" id="tabAll">
                        All Returns
                    </button>
                    <button onclick="filterReturns('pending')" class="px-6 py-3 font-semibold hover:bg-gray-50" id="tabPending">
                        Pending
                    </button>
                    <button onclick="filterReturns('approved')" class="px-6 py-3 font-semibold hover:bg-gray-50" id="tabApproved">
                        Approved
                    </button>
                    <button onclick="filterReturns('rejected')" class="px-6 py-3 font-semibold hover:bg-gray-50" id="tabRejected">
                        Rejected
                    </button>
                </div>
            </div>

            <!-- Returns Table -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="overflow-x-auto">
                    <table class="min-w-full">
                        <thead>
                            <tr class="border-b">
                                <th class="text-left py-3 px-4">Return #</th>
                                <th class="text-left py-3 px-4">Date</th>
                                <th class="text-left py-3 px-4">Invoice</th>
                                <th class="text-left py-3 px-4">Product</th>
                                <th class="text-left py-3 px-4">Qty</th>
                                <th class="text-left py-3 px-4">Refund</th>
                                <th class="text-left py-3 px-4">Status</th>
                                <th class="text-left py-3 px-4">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="returnsTable">
                            <tr>
                                <td colspan="8" class="text-center py-4">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="../js/config.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/api.js"></script>
    <script>
        let currentFilter = null;

        $(document).ready(function() {
            if (!checkAuth()) return;
            loadReturns();
        });

        async function filterReturns(status) {
            currentFilter = status === 'all' ? null : status;
            
            // Update active tab
            $('[id^="tab"]').removeClass('border-b-2 border-blue-600').addClass('hover:bg-gray-50');
            $(`#tab${status.charAt(0).toUpperCase() + status.slice(1)}`).addClass('border-b-2 border-blue-600').removeClass('hover:bg-gray-50');
            
            loadReturns();
        }

        async function loadReturns() {
            try {
                const returns = await api.getReturns(currentFilter);

                if (returns.length === 0) {
                    $('#returnsTable').html('<tr><td colspan="8" class="text-center py-4 text-gray-500">No returns found</td></tr>');
                    return;
                }

                let html = '';
                for (const ret of returns) {
                    const sale = await api.getSale(ret.sale_id);
                    const product = sale.items.find(i => i.product_id === ret.product_id);

                    html += `
                        <tr class="border-b hover:bg-gray-50">
                            <td class="py-3 px-4 font-semibold">${ret.return_number}</td>
                            <td class="py-3 px-4">${formatDateOnly(ret.return_date)}</td>
                            <td class="py-3 px-4">${sale.invoice_number}</td>
                            <td class="py-3 px-4">${product?.product_name || 'N/A'}</td>
                            <td class="py-3 px-4 text-center">${ret.quantity}</td>
                            <td class="py-3 px-4 font-bold text-red-600">${formatCurrency(ret.refund_amount)}</td>
                            <td class="py-3 px-4">
                                <span class="px-3 py-1 rounded-full text-xs ${getStatusBadge(ret.status)}">
                                    ${ret.status}
                                </span>
                            </td>
                            <td class="py-3 px-4">
                                ${ret.status === 'pending' && isManager() ? `
                                    <button onclick="processReturn(${ret.id}, 'approved')" class="text-green-600 hover:text-green-800 mr-2" title="Approve">
                                        <i class="fas fa-check-circle"></i>
                                    </button>
                                    <button onclick="processReturn(${ret.id}, 'rejected')" class="text-red-600 hover:text-red-800" title="Reject">
                                        <i class="fas fa-times-circle"></i>
                                    </button>
                                ` : `
                                    <span class="text-gray-400">-</span>
                                `}
                            </td>
                        </tr>
                    `;
                }

                $('#returnsTable').html(html);
            } catch (error) {
                $('#returnsTable').html('<tr><td colspan="8" class="text-center py-4 text-red-500">Failed to load returns</td></tr>');
            }
        }

        async function processReturn(id, status) {
            const action = status === 'approved' ? 'Approve' : 'Reject';
            
            const result = await Swal.fire({
                title: `${action} Return?`,
                text: `Are you sure you want to ${action.toLowerCase()} this return?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: `Yes, ${action.toLowerCase()}!`,
                confirmButtonColor: status === 'approved' ? '#10b981' : '#dc2626'
            });

            if (result.isConfirmed) {
                try {
                    showLoading();
                    await api.processReturn(id, status);
                    showSuccess(`Return ${status} successfully`);
                    loadReturns();
                } catch (error) {
                    showError(`Failed to process return`);
                }
            }
        }
    </script>
</body>
</html>
